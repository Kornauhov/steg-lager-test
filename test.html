<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Patch appId</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white p-8">

<h1 class="text-2xl font-black mb-6">appId Patch Tool</h1>

<button id="run" class="bg-emerald-600 px-6 py-3 rounded-xl font-black">
  Start Patch
</button>

<pre id="log" class="mt-6 bg-black p-4 rounded-xl text-sm overflow-auto max-h-[500px]"></pre>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  writeBatch
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGqPXXcmJTbL3PVrn-PKL0Gig45r6GPbQ",
  authDomain: "steg-lager-test.firebaseapp.com",
  projectId: "steg-lager-test",
  storageBucket: "steg-lager-test.firebasestorage.app",
  messagingSenderId: "655203951825",
  appId: "1:655203951825:web:9edcfb40f29ed70f61d1f0"
};

const APP_ID = "stege-lager-v1";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const log = (msg) => {
  const el = document.getElementById("log");
  el.textContent += msg + "\n";
  el.scrollTop = el.scrollHeight;
};

async function patchCollectionRecursive(colRef) {
  const snap = await getDocs(colRef);

  let batch = writeBatch(db);
  let batchCount = 0;
  let updated = 0;

  for (const docSnap of snap.docs) {
    const data = docSnap.data() || {};
    const docRef = docSnap.ref;

    if (!data.appId) {
      batch.update(docRef, { appId: APP_ID });
      batchCount++;
      updated++;

      if (batchCount >= 500) {
        await batch.commit();
        log("Batch commit 500");
        batch = writeBatch(db);
        batchCount = 0;
      }
    }

    // rekursiv Subcollections
    const subcols = await docRef.listCollections();
    for (const sub of subcols) {
      updated += await patchCollectionRecursive(sub);
    }
  }

  if (batchCount > 0) {
    await batch.commit();
    log("Batch commit final " + batchCount);
  }

  return updated;
}

document.getElementById("run").onclick = async () => {
  log("Authenticating...");
  await signInAnonymously(auth);

  log("Start patching...");

  const rootCollection = collection(
    db,
    "artifacts",
    APP_ID,
    "public",
    "data"
  );

  let totalUpdated = await patchCollectionRecursive(rootCollection);

  log("DONE âœ…");
  log("Updated documents: " + totalUpdated);
};
</script>

</body>
</html>
