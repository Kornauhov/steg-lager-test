<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Smart Steg PRO - Lagerverwaltung</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@0.344.0/dist/umd/lucide.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f8fafc; }
    .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #facc15; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
    .grid-cell { transition: all 0.2s ease-in-out; }
    .grid-cell:active { transform: scale(0.9); }
    .glass-effect { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); }
  </style>
</head>

<body class="bg-slate-50">
  <!-- Boot screen -->
  <div id="boot" style="
    position:fixed; inset:0; display:flex; flex-direction:column; gap:12px;
    align-items:center; justify-content:center;
    background:#0f172a; color:#facc15;
    font:900 14px/1.4 Inter,system-ui,sans-serif;
    letter-spacing:.12em; text-transform:uppercase;
    z-index:999999; padding:24px; text-align:center;
  ">
    <div style="font-size:18px; letter-spacing:.18em;">Smart Steg PRO lädt…</div>
    <div style="color:#94a3b8; font-weight:800; letter-spacing:.08em; text-transform:none; font-size:12px; max-width:560px;">
      Wenn das nicht verschwindet: Scripts starten nicht oder es gibt einen JS-Fehler.
    </div>
    <div id="bootHint" style="display:none; color:#fb7185; font-weight:900; letter-spacing:.06em; text-transform:none; font-size:12px; max-width:560px;">
      App ist nicht gestartet. Bitte Browser-Konsole öffnen (F12 → Console).
    </div>
    <div style="margin-top:6px; width:56px; height:56px; border-radius:999px; border:5px solid #facc15; border-top-color:transparent; animation:spin 1s linear infinite;"></div>
  </div>

  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>

  <div id="root"></div>

  <script>
    window.__APP_STARTED__ = false;
    setTimeout(() => {
      if (!window.__APP_STARTED__) {
        const hint = document.getElementById("bootHint");
        if (hint) hint.style.display = "block";
      }
    }, 4000);

    window.addEventListener("error", (e) => {
      const boot = document.getElementById("boot");
      if (!boot) return;
      boot.style.background = "#0b1220";
      boot.style.color = "#fca5a5";
      boot.innerHTML =
        "<pre style='white-space:pre-wrap;max-width:960px;text-align:left;font:14px/1.4 ui-monospace,monospace;color:#fca5a5'>" +
        "JS ERROR:\\n" + (e.message || e.error) + "\\n\\n" +
        (e.filename ? (e.filename + ':' + e.lineno + ':' + e.colno + "\\n\\n") : "") +
        (e.error && e.error.stack ? e.error.stack : "") +
        "</pre>";
    });

    window.addEventListener("unhandledrejection", (e) => {
      const boot = document.getElementById("boot");
      if (!boot) return;
      boot.style.background = "#0b1220";
      boot.style.color = "#fca5a5";
      boot.innerHTML =
        "<pre style='white-space:pre-wrap;max-width:960px;text-align:left;font:14px/1.4 ui-monospace,monospace;color:#fca5a5'>" +
        "PROMISE ERROR:\\n" + (e.reason?.message || e.reason) + "\\n\\n" +
        (e.reason?.stack || "") +
        "</pre>";
    });
  </script>

  <!--
    IMPORTANT FIX:
    Vorher wurde Firebase per <script type="module"> geladen. Module-Skripte werden "deferred" ausgeführt,
    während das nachfolgende Babel-Script sofort läuft → FirebaseSDK war manchmal noch nicht da.

    Jetzt laden wir Firebase *innerhalb* des Babel-Skripts via dynamic import(), warten darauf,
    und starten erst dann React + Firestore.
  -->
  <script type="text/babel">
    const { useEffect, useMemo, useState, useRef } = React;

    // -----------------------------
    // Pure helpers (testable)
    // -----------------------------
    const safeDocId = (s) => String(s || "").replace(/\//g, "_").trim();
    const slotIdFrom = (shelf, level) => `${String(shelf)}_L${Number(level)}`;

    const deriveFromPath = (path) => {
      const parts = String(path || "").split("/");
      const idx = parts.indexOf("slots");
      if (idx === -1) return { slotId: null, shelf: null, level: null };
      const slotId = parts[idx + 1] || null;
      if (!slotId) return { slotId: null, shelf: null, level: null };
      const m = String(slotId).match(/^(.+)_L(\d+)$/);
      if (!m) return { slotId, shelf: null, level: null };
      return { slotId, shelf: m[1], level: Number(m[2]) };
    };

    // -----------------------------
    // Minimal test harness (no deps)
    // -----------------------------
    function runTests() {
      const tests = [];
      const assertEq = (name, a, b) => {
        const ok = JSON.stringify(a) === JSON.stringify(b);
        tests.push({ name, ok, a, b });
      };

      assertEq("safeDocId replaces slashes", safeDocId("A/B/C"), "A_B_C");
      assertEq("slotIdFrom formats", slotIdFrom("C1", 3), "C1_L3");
      assertEq(
        "deriveFromPath extracts slot fields",
        deriveFromPath("artifacts/x/public/data/slots/C12_L5/items/abc"),
        { slotId: "C12_L5", shelf: "C12", level: 5 }
      );
      assertEq(
        "deriveFromPath returns nulls when missing",
        deriveFromPath("artifacts/x/public/data/other/abc"),
        { slotId: null, shelf: null, level: null }
      );

      // Normalization test with mixed shapes
      const mockRaw = [
        { __path: "artifacts/app/public/data/slots/C1_L1/items/it1", __id: "it1", itemKey: "S1", quantity: 2 },
        { __path: "artifacts/app/public/data/slots/C1_L1/items/it2", __id: "it2", key: "S2", quantity: 0 }, // filtered (qty 0)
        { __path: "artifacts/app/public/data/slots/C2_L3/items/it3", __id: "it3", code: "S3", quantity: "7" },
        { __path: "artifacts/app/public/data/slots/C2_Lx/items/it4", __id: "it4", code: "S4", quantity: 1 }, // malformed slot id
      ];

      const normalized = [];
      for (const d of mockRaw) {
        const derived = deriveFromPath(d.__path || "");
        const shelf = d.shelf ?? d.location?.shelf ?? derived.shelf;
        const level = Number(d.level ?? d.location?.level ?? derived.level);
        const slotId = d.slotId ?? derived.slotId ?? (shelf && level ? slotIdFrom(shelf, level) : null);
        const itemKey = d.itemKey ?? d.key ?? d.code ?? d.__id;
